name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  WASM_PACK_VERSION: "0.14.0"

jobs:
  # Build native binaries for all platforms
  build-native:
    name: Build Native - ${{ matrix.config.os }}
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_name: wgpu_playground
            artifact_name: wgpu_playground-linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_name: wgpu_playground.exe
            artifact_name: wgpu_playground-windows-x64
          - os: macos-latest
            target: x86_64-apple-darwin
            binary_name: wgpu_playground
            artifact_name: wgpu_playground-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            binary_name: wgpu_playground
            artifact_name: wgpu_playground-macos-arm64
    
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.config.target }}
      
      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release-${{ matrix.config.target }}"
      
      - name: Build release binary
        run: cargo build --release --bin wgpu_playground --target ${{ matrix.config.target }}
      
      - name: Package binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p artifacts
          cp target/${{ matrix.config.target }}/release/${{ matrix.config.binary_name }} artifacts/
          cd artifacts
          tar czf ${{ matrix.config.artifact_name }}.tar.gz ${{ matrix.config.binary_name }}
          
      - name: Package binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          Copy-Item target/${{ matrix.config.target }}/release/${{ matrix.config.binary_name }} artifacts/
          Compress-Archive -Path artifacts/${{ matrix.config.binary_name }} -DestinationPath artifacts/${{ matrix.config.artifact_name }}.zip
      
      - name: Upload native artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.config.artifact_name }}
          path: |
            artifacts/*.tar.gz
            artifacts/*.zip
          retention-days: 7

  # Build WASM bundle
  build-wasm:
    name: Build WASM Bundle
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "wasm-release"

      - name: Cache wasm-pack
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin/wasm-pack
          key: ${{ runner.os }}-wasm-pack-${{ env.WASM_PACK_VERSION }}

      - name: Install wasm-pack
        run: |
          if ! command -v wasm-pack &> /dev/null; then
            cargo install wasm-pack --version ${{ env.WASM_PACK_VERSION }}
          fi

      - name: Build WASM bundle
        run: |
          cd crates/wgpu_playground_core
          wasm-pack build --target web --release

      - name: Package WASM bundle
        run: |
          mkdir -p artifacts/wasm-bundle
          cp -r crates/wgpu_playground_core/pkg/* artifacts/wasm-bundle/
          cd artifacts
          tar czf wgpu_playground-wasm-bundle.tar.gz wasm-bundle/
      
      - name: Upload WASM artifact
        uses: actions/upload-artifact@v6
        with:
          name: wasm-bundle
          path: artifacts/wgpu_playground-wasm-bundle.tar.gz
          retention-days: 7

  # Build documentation
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "docs-release"
      
      - name: Build documentation
        run: cargo doc --workspace --all-features --no-deps
      
      - name: Create index redirect
        run: |
          cat > target/doc/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>wgpu_playground Documentation</title>
            <meta http-equiv="refresh" content="0; url=wgpu_playground_core/index.html">
          </head>
          <body>
            <p>Redirecting to <a href="wgpu_playground_core/index.html">wgpu_playground_core documentation</a>...</p>
          </body>
          </html>
          EOF
      
      - name: Add .nojekyll file
        run: touch target/doc/.nojekyll
      
      - name: Package documentation
        run: |
          cd target
          tar czf ../wgpu_playground-docs.tar.gz doc/
      
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v6
        with:
          name: documentation
          path: wgpu_playground-docs.tar.gz
          retention-days: 7

  # Create GitHub Release with all artifacts
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-native, build-wasm, build-docs]
    steps:
      - uses: actions/checkout@v6
      
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
      
      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f
      
      - name: Extract release version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## wgpu_playground Release ${{ steps.version.outputs.version }}

          ### Downloads

          #### Native Binaries
          - **Linux (x64)**: `wgpu_playground-linux-x64.tar.gz`
          - **Windows (x64)**: `wgpu_playground-windows-x64.zip`
          - **macOS (Intel)**: `wgpu_playground-macos-x64.tar.gz`
          - **macOS (Apple Silicon)**: `wgpu_playground-macos-arm64.tar.gz`

          #### WASM Bundle
          - **WASM**: `wgpu_playground-wasm-bundle.tar.gz` - WebAssembly build for web deployment

          #### Documentation
          - **Docs**: `wgpu_playground-docs.tar.gz` - Complete API documentation

          ### Installation

          #### Native Binaries
          Download the appropriate archive for your platform, extract it, and run the binary:
          ```bash
          # Linux/macOS
          tar xzf wgpu_playground-*.tar.gz
          ./wgpu_playground

          # Windows (PowerShell)
          Expand-Archive wgpu_playground-windows-x64.zip
          .\wgpu_playground.exe
          ```

          #### WASM Bundle
          Extract the WASM bundle and serve it with a web server:
          ```bash
          tar xzf wgpu_playground-wasm-bundle.tar.gz
          # Serve the wasm-bundle directory with your web server
          ```

          ### What's Changed
          See the [CHANGELOG](https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.tag }}...${{ steps.version.outputs.tag }}) for details.
          EOF
          
          echo "Release notes generated successfully"
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
